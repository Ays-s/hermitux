HERMITUX_BASE=/home/pierre/Desktop/hermitux

HERMIT_LOCAL_INSTALL=$(HERMITUX_BASE)/hermit-compiler/prefix
MUSL_GCC=$(HERMITUX_BASE)/musl/prefix/bin/musl-gcc

# get chrono here https://github.com/olivierpierre/chrono
CHRONO=/usr/local/bin/chrono

CFLAGS=-g -O3
LDFLAGS=-static

SRC := $(shell ls *.c)
OBJ=$(SRC:.c=.o)
PROG?=prog

KERNEL=$(HERMIT_LOCAL_INSTALL)/x86_64-hermit/extra/tests/hermitux
VERBOSE=0
ISLE=uhyve
KVM=0
STRIP=1

all: $(PROG)

$(PROG): $(SRC)
	@$(MUSL_GCC) $(CFLAGS) $^ -o $@ $(LDFLAGS) 
ifeq ($(STRIP),1)
	@strip $(PROG)
endif

objdump:
	objdump --source $(PROG) > /tmp/objdump.txt && vim /tmp/objdump.txt

test: $(PROG)
	@make -B $(PROG) --no-print-directory
	@HERMIT_VERBOSE=$(VERBOSE) HERMIT_ISLE=$(ISLE) HERMIT_TUX=1 \
				HERMIT_KVM=$(KVM) $(CHRONO) $(HERMIT_LOCAL_INSTALL)/bin/proxy \
				$(KERNEL) $(PROG) $(ARGS) | grep -e "Time in" -e "chrono"

gdb:
	HERMIT_VERBOSE=$(VERBOSE) HERMIT_DEBUG=1 \
				HERMIT_ISLE=qemu HERMIT_KVM=0 \
				$(HERMIT_LOCAL_INSTALL)/bin/proxy $(PROG)

clean:
	rm -rf *.o $(PROG)

